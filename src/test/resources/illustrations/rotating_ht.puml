@startuml
title Rotating Refresh Token System

actor User
boundary ClientApp
entity Database

User -> ClientApp : Login with credentials
ClientApp -> Database : Validate credentials
Database --> ClientApp : Credentials valid
ClientApp -> User : JWT + Refresh Token (unhashed)

User -> ClientApp : Request with expired JWT + Refresh Token
ClientApp -> Database : Validate Refresh Token (hashed)
Database --> ClientApp : Refresh Token valid
ClientApp -> User : New JWT + New Refresh Token (unhashed)
ClientApp -> Database : Store new hashed Refresh Token
ClientApp -> Database : Invalidate old Refresh Token

ClientApp -> Database : Check for Refresh Token (hashed)
ClientApp -> User : Error (Invalid Token) if token exists

@enduml
